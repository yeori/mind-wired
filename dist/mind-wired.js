!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.mindwired=e():t.mindwired=e()}(self,(()=>(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})}};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),t.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var s=t.g.document;if(!e&&s&&(s.currentScript&&(e=s.currentScript.src),!e)){var i=s.getElementsByTagName("script");i.length&&(e=i[i.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})();var e={};t.r(e),t.d(e,{createDataSource:()=>Gt,default:()=>Xt,init:()=>jt});class s{constructor(t){this.expression=t}get isClass(){return"."===this.expression.charAt(0)}get isId(){return"#"===this.expression.charAt(0)}get value(){return this.expression.substring(1)}setAttribute(t){if(this.isId)t.setAttribute("id",this.value);else{if(!this.isClass)throw new Error(`neither id nor class : [${this.expression}]`);t.classList.add(this.value)}}}const i=(t,e)=>{if(1===t.nodeType)return t.closest(e);if(3===t.nodeType)return t.parentElement.closest(e);throw new Error(`node type ${t.nodeTye}, tag(${t.nodeName})`)},n=t=>(t||"").split(" ").map((t=>t.trim())).filter((t=>t.length>0)),o=(t,e)=>{const i=document.createElement(t);return e.forEach((t=>{new s(t).setAttribute(i)})),i},r={span:(t,e)=>{const s=o("span",n(t));return e&&(s.innerHTML=e),s},iconButton:(t,e)=>{const s=o("BUTTON",n(t));return s.innerHTML=e,s},img:t=>{const e=document.createElement("img");return new Promise(((s,i)=>{e.onload=()=>{s({img:e,width:e.naturalWidth,height:e.naturalHeight})},e.onerror=()=>{console.log("ERROR"),i("NOT_ALLOWED")},e.crossOrigin="Anonymous",e.src=t}))},div:t=>o("DIV",n(t)),canvas:t=>o("CANVAS",n(t))},d=(t,e,s,i)=>{(t||window).addEventListener(e,s,i||!1)},a=(t,e,s,i)=>{t.addEventListener(e,(t=>{const e=t.code.toLowerCase(),{keys:n}=i;for(let i=0;i<n.length;i++){const o=n[i],{ctrlKey:r,shiftKey:d,altKey:a,metaKey:c}=t;if("*"===o.code||o.code===e&&o.alt===a&&o.meta===c&&o.shift===d&&o.ctrl===r){s(t);break}}}))},c=t=>{let[e,s]=t.split("@");s||(s=e,e="");const i=e.split("+");return{ctrl:i.includes("ctrl"),shift:i.includes("shift"),alt:i.includes("alt"),meta:i.includes("meta"),code:s}},h={int:(t,e)=>{const s={};return e.forEach((e=>{const i=t.dataset[e];s[e]=parseInt(i,10)})),s}},l=t=>t.stopPropagation(),g={createEventBus:()=>new EventBus,consume:(t,e)=>{t.addEventListener(e,l)},focus:(t,e,s)=>d(t,"focus",e,s),mousedown:(t,e,s)=>{d(e,"mousedown",t,s)},mousemove:(t,e,s)=>{d(e,"mousemove",t,s)},mouseup:(t,e,s)=>{d(e,"mouseup",t,s)},touchstart:(t,e,s)=>{d(e,"touchstart",t,s)},touchmove:(t,e,s)=>{d(e,"touchmove",t,s)},touchend:(t,e,s)=>{d(e,"touchend",t,s)},click:(t,e,s)=>{d(t,"click",e,s)},keydown:(t,e,s)=>{const i=(s=s||"*").split(" ").filter((t=>t.trim().length>0)).map((t=>c(t)));a(t,"keydown",e,{keys:i})},keyup:(t,e,s)=>{const i=(s=s||"*").split(" ").filter((t=>t.trim().length>0)).map((t=>c(t)));a(t,"keyup",e,{keys:i})},resize:(t,e)=>{}},u={width:t=>"number"==typeof t?`${t}px`:t};"top,left,height,minWidth,minHeight".split(",").forEach((t=>{u[t]=u.width}));const f={tag:r,attr:(t,e,s,i)=>{const n=t.getAttribute(e);!i&&n||t.setAttribute(e,s)},clazz:{add:(t,e)=>t.classList.add(e),remove:(t,e)=>t.classList.remove(e)},closest:i,imageSize:t=>{const e=new XMLHttpRequest;e.open("HEAD",t,!0),e.onreadystatechange=()=>{e.readyState===e.DONE&&console.log(e.getResponseHeader("Content-Length"))},e.send()},fileToImage:t=>{const e=new FileReader;return new Promise((s=>{e.addEventListener("load",(()=>{const i=document.createElement("img");i.src=e.result,s({file:t,img:i})})),e.readAsDataURL(t)}))},event:g,css:(t,e)=>{Object.keys(e).forEach((s=>{const i=(u[s]||(t=>t))(e[s]);t.style[s]=i}))},parseTemplate:(t,e)=>{let s=t;Object.keys(e||{}).forEach((t=>{const i="@"+t,n=e[t];s=s.replaceAll(i,n)}));const i=document.createElement("template");return i.innerHTML=s,i.content.firstElementChild},findOne:(t,e)=>t.querySelector(e),is:(t,e,s=!0)=>{const n=t.matches(e);return n||!!s&&!!i(t,e)},data:h,domRect:t=>t.getBoundingClientRect(),types:{method:t=>"function"==typeof t},valid:{path:t=>new Promise(((e,s)=>{const i=t&&t.trim();i.length>0?e(i):s(t)})),number:t=>new Promise(((e,s)=>{const i=parseFloat(t);Number.isNaN(i)?s(t):e(i)})),string:t=>"string"==typeof t&&t.trim().length>0}},p=t=>{if("number,string,boolean,undefined".includes(typeof t))return!0},m=t=>"function"==typeof t,y=t=>{if(null==t||p(t)||m(t))return t;const e=Array.isArray(t)?[]:{};return Object.keys(t).forEach((s=>{const i=y(t[s]);e[s]=i})),e},v=(t,e)=>(Object.keys(t).forEach((s=>{null===e[s]||void 0===e[s]?e[s]=y(t[s]):p(t[s])||m(t[s])?e[s]=t[s]:v(t[s],e[s])})),e),E={deepCopy:y,mergeLeaf:v},x={DRAG:{VIEWPORT:{name:"viewport dragged",desc:""},NODE:{name:"node dragged",desc:""}},SELECTION:{NODE:{name:"node selected",desc:""}},EDIT:{NODE:{name:"editing state of a node",desc:""}},NODE:{CREATED:{name:"node.created",desc:"",CLIENT:{name:"node.created.client",desc:"client-side node creation event"}},DELETED:{name:"node.deleted",desc:"node has been deleted",CLIENT:{name:"node.deleted.client",desc:"client-side node deletion event"}},UPDATED:{name:"node.updated",desc:"content of node updated",CLIENT:{name:"node.updated.client",desc:"client-side node update event"}},SELECTED:{name:"node.selected",desc:"one or more nodes selected",CLIENT:{name:"node.selected.client",desc:"client-side node selection event"}},EDITING:{name:"node.editing",desc:"node's editing state"},FOLDED:{name:"node.folded",desc:"node is folded or unfolded"}},VIEWPORT:{RESIZED:{name:"viewport.resized",desc:"viewport size chaged"},CLICKED:{name:"viewport.clicked",desc:"viewport has been clicked"}}},w=new Set;class b{constructor(){this.callbacks=new Map}on(t,e){let s=this.callbacks.get(t);s||(s=new Set,this.callbacks.set(t,s)),s.add(e)}off(t,e){const s=this.callbacks.get(t);if(!s)return;const i=s.findIndex((t=>t===e));s.splice(i,1)}listen(t,e){const s=(t=>{const e=t.toUpperCase().split(".");let s=x;for(let i=0;i<e.length;i++)if(s=s[e[i]],!s)throw new Error(`invalid event name: [${t}]`);if(s.name!==t)throw new Error(`event name mismatch: [${t}]`);return s})(t);this.on(s,e)}emit(t,e,s){(this.callbacks.get(t)||w).forEach((t=>{try{t(e)}catch(t){console.log(t)}})),s&&setTimeout((()=>{this.emit(t.CLIENT,e)}))}}const D=()=>{},N=D,C=D,O=t=>{let e=t.touches[0];"touchend"===t.type&&(e=t.changedTouches[0]),t.clientX=e.clientX,t.clientY=e.clientY,t.layerX=0,t.layerY=0,t.offsetX=0,t.offsetY=0,t.pageX=e.pageX,t.pageY=e.pageY,t.screenX=e.screenX,t.screenY=e.screenY},I=t=>{clearTimeout(t.touchTimer),t.touchTimer=null},T=(t,e)=>{const{handler:s}=t;s.accept(e.target)&&(t.dragging={originalEvent:e,sx:e.pageX,sy:e.pageY,dx:0,dy:0,ghost:null,once:null},s.beforeDrag(t.dragging))},$=(t,e)=>{t.dragging&&(e.preventDefault(),t.dragging.once&&(t.dragging.once(),t.dragging.once=null),t.originalEvent=e,t.originalEvent=e,t.dragging.dx=e.pageX-t.dragging.sx,t.dragging.dy=e.pageY-t.dragging.sy,t.handler.dragging(t.dragging))},S=(t,e)=>{t.originalEvent=e,document.querySelector("body").style.cursor="";try{t.dragging&&t.handler.afterDrag(t.dragging)}catch(e){console.log("[DND error]",e)}finally{t.data.clear(),t.dragging=null}};class R{constructor(t){this.touchTimer=null,this.dragging=null,this.handler=t,this.data=new Map,(t=>{const{handler:e}=t;e.beforeDrag=e.beforeDrag||D,e.dragging=e.dragging||N,e.afterDrag=e.afterDrag||C,window.addEventListener("mousedown",(e=>T(t,e)),!1),window.addEventListener("mousemove",(e=>$(t,e)),{passive:!1}),window.addEventListener("mouseup",(e=>S(t,e)),!1),window.addEventListener("touchstart",(e=>((t,e)=>{t.touchTimer=setTimeout((()=>{O(e),T(t,e)}),10)})(t,e)),!1),window.addEventListener("touchmove",(e=>((t,e)=>{I(t),O(e),$(t,e)})(t,e)),{passive:!1}),window.addEventListener("toucend",(e=>((t,e)=>{I(t),O(e),S(t,e)})(t,e)),!1)})(this)}capture(t,e){this.data.set(t,e)}getData(t){return this.data.get(t)}}const L=t.p+"9f164502f05270fbb81d.svg",M=t.p+"c42450f49d27dbb24438.svg",P=(t,e,s,{scale:i=1})=>{const n=(e.x-t.x)*i,o=(e.y-t.y)*i,r=s*Math.PI/180,d=Math.cos(r),a=Math.sin(r);return{x:n*d-o*a+t.x,y:n*a+o*d+t.y}},A=window.devicePixelRatio,U={viewport:`<div data-mind-wired-viewport>\n    <canvas></canvas>\n    <div class="mwd-selection-area"><div class="ctrl-icon" data-cmd="set-para" style="display:none; background-image: url(${L});"></div></div>\n    <div class="mwd-nodes"></div>\n  </div>`,node:'<div class="mwd-node">\n    <div class="mwd-body" tabIndex="0"></div>\n    <div class="mwd-subs"></div>\n    <div class="mwd-node-ctrl"></div>\n  </div>',foldingControl:`<div class="ctrl-icon" data-cmd="unfolding" style="background-image: url(${M});"></div>`};class k{constructor(t,e){const s=t.offset();s.x*=e,s.y*=e;const i=f.domRect(t.$bodyEl),{width:n,height:o}=i;this.top=s.y-o/2,this.right=s.x+n/2,this.bottom=s.y+o/2,this.left=s.x-n/2,this.width=n,this.height=o,this.cx=s.x,this.cy=s.y,this.icon=null}merge(t){return this.top=Math.min(this.top,t.top),this.right=Math.max(this.right,t.right),this.bottom=Math.max(this.bottom,t.bottom),this.left=Math.min(this.left,t.left),this.width=this.right-this.left,this.height=this.bottom-this.top,this.cx=this.width/2,this.cy=this.height/2,this}draw(t){const{selection:e}=t.config.ui,s=t.getHolderOffset(),i=f.findOne(t.$viewport,".mwd-selection-area");f.css(i,{left:s.x+this.left-e.padding,top:s.y+this.top-e.padding,width:this.width+2*e.padding,height:this.height+2*e.padding});const n=f.findOne(i,"div");f.css(n,{display:"",width:24/Math.max(t.scale,1),height:24/Math.max(t.scale,1)})}clear(t){const e=f.findOne(t.$viewport,".mwd-selection-area");f.css(e,{top:-1,left:-1,width:0,height:0});const s=f.findOne(e,"div");f.css(s,{display:"none"})}}const z=t=>{const{config:e,$viewport:s,$canvas:i}=t,{offsetWidth:n,offsetHeight:o}=s;f.css(i,{width:n,height:o}),f.attr(i,"width",A*n,!0),f.attr(i,"height",A*o,!0);const r=i.getContext("2d",{alpha:!1});t.$ctx=r,t.$ctx.scale(A,A),t.selectionArea&&t.selectionArea.draw(t),e.emit(x.VIEWPORT.RESIZED)},W=(t,e)=>{if(e.$el)throw new Error(`[MINDWIRED][ERROR] already installed. (${e.uid})`);const s=e.$el=f.parseTemplate(U.node),i=t.config.getNodeRenderer(),{model:n}=e,o=t.getNodeBody(e);i.getRenderer(n.type).install(e,o),n.schema&&((t,e,s)=>{const i=s.ui.clazz.schema(t);f.clazz.add(e,i)})(n.schema,o,t.config);const r=t.elemOf(".mwd-nodes");return e.isRoot()?r.append(s):f.findOne(e.parent.$el,".mwd-subs").append(s),s.dataset.uid=e.uid,e.$el},H=(t,e)=>{f.css(t.$el,{display:e}),t.isFolded()||t.subs.forEach((t=>{H(t,e)}))},q=(t,e,s)=>{Object.keys(e||{}).forEach((s=>{const i=e[s];t[s]=i})),s&&"function"==typeof s&&s(t)},B={name:"line",option:{},color:"#000000",width:1},F=(t,e)=>{let s=t,i=s.getStyle("edge");for(;!i[e]&&!s.isRoot();)s=s.parent,i=s.getStyle("edge");return i[e]||B[e]},V=class{constructor(t){this.nodeUI=t}get name(){return F(this.nodeUI,"name")}get option(){return F(this.nodeUI,"option")}get color(){return F(this.nodeUI,"color")}get width(){return F(this.nodeUI,"width")}getEdgeRenderer(){const t=this.nodeUI.getStyle("edge").renderer;if(!t)return null;const e=this.nodeUI.sharedConfig,{renderers:s}=e.ui;if(!s)throw new Error(`You should define renderer at "ui.renderers:{${t}: (ctx) => {}, }" for edge renderer [${t}]`);if(!s[t])throw new Error(`edge renderer [${t}] does not exist in ui.renders`);return s[t]}},j=t=>{const{width:e}=t.$style;return"function"==typeof e?e(t):e},G=(t,e,s,i)=>{const n=j(e);t.drawPath([{x:s.left-i.hor,y:s.bottom+i.ver},{x:s.right+i.hor,y:s.bottom+i.ver}],{lineWidth:n,strokeStyle:e.$style.color},e.$style.getEdgeRenderer())},X=t=>{const{width:e}=t.$style;return"function"==typeof e?e(t):e},Y={LINE:(t,e,s)=>{const{scale:i}=t,[n,o]=[e,s].map((t=>{const e=t.offset();e.x*=i,e.y*=i;const s=f.domRect(t.$bodyEl),{width:n,height:o}=s;return e.left=e.x-n/2,e.right=e.x+n/2,e.top=e.y-o/2,e.bottom=e.y+o/2,e.width=n,e.height=o,e})),r=s.$style;t.drawPath([n,o],{lineWidth:r.width*i,strokeStyle:r.color},r.getEdgeRenderer())},NATURAL_CURVE:(t,e,s)=>{const{scale:i}=t,[n,o]=[e,s].map((t=>t.offset(i))),r=s.$style;t.drawCurve(n,o,{degree:r.option.deg||20,ratio:r.option.ratio||.4,props:{lineWidth:r.width*i,strokeStyle:r.color}},r.getEdgeRenderer())},MUSTACHE_LR:(t,e,s)=>{const{scale:i}=t,[n,o]=[e,s].map((t=>{const e=t.offset();e.x*=i,e.y*=i;const s=f.domRect(t.$bodyEl),{width:n,height:o}=s;return e.left=e.x-n/2,e.right=e.x+n/2,e.top=e.y-o/2,e.bottom=e.y+o/2,e.width=n,e.height=o,e})),r={hor:0,ver:0};let d,a;"bottom"===(t=>{const{option:e}=t.$style;return e&&e.valign||"center"})(e)&&(r.ver=5),n.x<=o.x?(d=n,a=o):(d=o,a=n),d.x=d.right+r.hor,a.x=a.left-r.hor,r.ver>0&&(d.y=d.bottom+r.ver,a.y=a.bottom+r.ver);const c=a.x-d.x;a.y,d.y,j(e),r.ver>0&&e.isRoot()&&e.firstChild()===s&&G(t,e,n,r),((t,e,s,i,n,o)=>{const r=j(e),d=j(i),a=Math.min(r,d),c=Math.abs(r-d);s.y-=c/2;const h={lineWidth:a,strokeStyle:i.$style.color},l=i.$style.getEdgeRenderer();t.drawBeizeCurve(s,n,{cpoints:[{x:s.x+o/2,y:s.y},{x:n.x-o/2,y:n.y}],props:h},l),c>0&&(s.y+=c,t.drawBeizeCurve(s,n,{cpoints:[{x:s.x+o/2,y:s.y},{x:n.x-o/2,y:n.y}],props:h},l))})(t,e,n,s,o,n===d?c:-c),r.ver>0&&G(t,s,o,r)},MUSTACHE_TB:(t,e,s)=>{const{scale:i}=t,[n,o]=[e,s].map((t=>{const e=t.offset(i),s=f.domRect(t.$bodyEl),{width:n,height:o}=s;return e.left=e.x-n/2,e.right=e.x+n/2,e.top=e.y-o/2,e.bottom=e.y+o/2,e.width=n,e.height=o,e}));let r,d;n.y<=o.y?(r=n,d=o):(r=o,d=n),r.y=r.bottom+5,d.y=d.top-5;const a=d.y-r.y;((t,e,s,i,n,o)=>{const{scale:r}=t,d=X(e),a=X(i),c=Math.min(d,a),h=Math.abs(d-a);s.x-=h/2;const l={lineWidth:c*r,strokeStyle:i.$style.color},g=i.$style.getEdgeRenderer();t.drawBeizeCurve(s,n,{cpoints:[{x:s.x,y:s.y+o/2},{x:n.x,y:n.y-o/2}],props:l},g),h>0&&(s.y+=h,t.drawBeizeCurve(s,n,{cpoints:[{x:s.x,y:s.y+o/2},{x:n.x,y:n.y-o/2}],props:l},g))})(t,e,n,s,o,n===r?a:-a)}},K=(t,e)=>{t.children((s=>{const i=new J(t,s);e.push(i),K(s,e)}))},_=(t,e)=>{const s=[];return t.forEach(((t,i)=>{e(t)&&s.push(i)})),s},Z=(t,e,s)=>{t.filterEdges((t=>t.src===e.dst&&!t.src.isFolded())).forEach((e=>{e.hidden=s,Z(t,e,s)}))};class J{constructor(t,e){this.srcNode=t,this.dstNode=e,this.hidden=!1}get src(){return this.srcNode}get dst(){return this.dstNode}matched(t){return this.srcNode===t||this.dstNode===t}matchedDst(t){return this.dstNode===t}}let Q=100,tt=1;class et{constructor(t,e,s){this.config=t,this.sharedConfig=e,this.$el=null,this.selected=!1,this.editing=!1,this.uid="uuid-"+Q++,this.zIndex=0,this.subs=(t=>{const{subs:e}=t.config;return e&&0!==e.length?e.map((e=>{const s=new et(e,t.sharedConfig);return s.parent=t,s})):[]})(this),this.parent=s,this.$style=new V(this),this.folding=!1,this.$dim=null}get model(){return{...this.config.model}}get $bodyEl(){return this.sharedConfig.getCanvas().getNodeBody(this)}get x(){return this.config.view.x}get y(){return this.config.view.y}get layout(){let{layout:t}=this.config.view;return t?{...t}:this.parent&&this.parent.layout}get active(){return!!this.$el}get childNodes(){return[...this.subs]}dimension(){const t=this.sharedConfig.scale,e=this.$bodyEl,s=this.offset();s.x*=t,s.y*=t;const i=e.offsetWidth*t/2,n=e.offsetHeight*t/2;return this.$dim={x:s.x-i,y:s.y-n,width:2*i,height:2*n,cx:s.x,cy:s.y,r:s.x+i,b:s.y+n}}level(){return this.isRoot()?0:this.parent.level()+1}getStyle(t){return Object.assign({},this.config.view[t])}isSelected(){return this.selected}setSelected(t){this.selected=t,this.zIndex=++tt,this.active&&this.repaint()}isDescendantOf(t){let e=this;for(;e;){if(e===t)return!0;e=e.parent}return!1}updateModel(t){const{model:e}=this.config;t(e)&&(this.$dim=null,this.sharedConfig.emit(x.NODE.UPDATED,[this]))}offset(){let t=this;const e={x:0,y:0};for(;t;){const s=1;e.x+=s*t.x,e.y+=s*t.y,t=t.parent}return e}setOffset({x:t,y:e}){if(this.isRoot())return;const s=this.parent.offset();this.setPos(t-s.x,e-s.y)}getPos(){return{x:this.x,y:this.y}}setPos(t,e,s=!0){this.config.view.x=t,this.config.view.y=e,s&&this.repaint()}isEditingState(){return this.editing}setEditingState(t){this.editing=t,this.repaint()}isRoot(){return this.config.root}isLeaf(){return 0===this.subs.length}children(t){this.subs.forEach((e=>t(e,this)))}find(t){let e=t(this);if(e)return this;for(let s=0;s<this.subs.length&&(e=this.subs[s].find(t),!e);s++);return e}addChild(t){const e=t.parent;return e&&e!==this&&e.removeChild(t),t.parent=this,this.subs.push(t),this.sharedConfig.getCanvas().moveNode(t),e}removeChild(t){if(t.parent!==this)return null;const e=this.subs.findIndex((e=>e.uid===t.uid));if(-1===e)return null;const s=this.subs.splice(e,1);return s.forEach((t=>t.parent=null)),s[0]}firstChild(){return this.subs[0]}lastChild(){return 0===this.subs.length?null:this.subs[this.subs.length-1]}setFolding(t){this.folding!==t&&(this.folding=t,this.repaint(),this.sharedConfig.emit(x.NODE.FOLDED,{node:this,folded:this.folding}))}isFolded(){return this.folding}repaint(){this.sharedConfig.getCanvas().drawNode(this);const{$el:t}=this,e=t.querySelector(".mwd-body"),s=this.getPos();f.css(t,{top:s.y,left:s.x,zIndex:this.zIndex});const i=this.isSelected()?"add":"remove",n=this.sharedConfig.activeClassName("node");f.clazz[i](e,n);const o=this.sharedConfig.nodeLevelClassName(this);f.clazz.add(e,o)}}et.build=(t,e)=>(t.root=!0,new et(t,e));const st=et,it={doLayout:t=>{},setPosition:()=>{}},nt={doLayout:(t,e)=>{const{dir:s}=e;s&&(s.updated("LR")||s.updated("RL"))&&t.children((t=>{((t,e)=>{const{x:s,y:i}=t;t.setPos(-s,i),e.layoutManager.getLayoutManager(t.layout).doLayout(t,e)})(t,e)}))},setPosition:(t,e)=>{const{baseNode:s,rect:i}=e,n=s.x,o=s.y+i.height+10;t.setPos(n,o)}},ot={doLayout:(t,e)=>{const{dir:s}=e;s&&(s.updated("TB")||s.updated("BT"))&&t.children((t=>{((t,e)=>{const{x:s,y:i}=t;t.setPos(s,-i),e.layoutManager.getLayoutManager(t.layout).doLayout(t,e)})(t,e)}))},setPosition:(t,e)=>{const{baseNode:s,rect:i}=e,n=s.x+i.width+10,o=s.y;t.setPos(n,o)}},rt={doLayout:(t,e)=>{const{dir:s}=e;s&&(nt.doLayout(t,e),ot.doLayout(t,e))},setPosition:(t,e)=>{nt.setPosition(t,e)}},dt=new Map;dt.set("DEFAULT",it),dt.set("X-AXIS",nt),dt.set("Y-AXIS",ot),dt.set("XY-AXIS",rt);const at=t=>t?dt.get(t.type):it,ct={getLayoutManager:at,setPosition:(t,e)=>{const{layout:s}=t;at(s).setPosition(t,e)},layout:(t,e)=>{const{layout:s}=t;at(s).doLayout(t,e)}},ht=t=>{for(let e of t.values())e.setSelected(!1);t.clear()},lt=t=>1!==t.length||!!t[0].isEditingState(),gt=(t,e,s)=>{t.config.mindWired().addNode(e,{model:{text:"TITLE"},siblingNode:s})},ut=t=>{const{config:e}=t,s=t.getNodes();setTimeout((()=>e.emit(x.NODE.SELECTED.CLIENT,{nodes:s})))},ft=(t,e)=>new class{constructor(t){this.config=t,this.nodeMap=new Map;const e=this.config.getCanvas();this.config.listen(x.NODE.SELECTED,(({node:t,append:e})=>{const s=this.nodeMap.has(t.uid);e?(this.nodeMap.set(t.uid,t),t.setSelected(!0),ut(this)):s||(ht(this.nodeMap),this.nodeMap.set(t.uid,t),t.setSelected(!0),ut(this))})),this.config.listen(x.VIEWPORT.CLICKED,(()=>{ht(this.nodeMap),e.hideSelection(),ut(this)})),f.event.keyup(e.$viewport,(t=>{if(this.isEmpty())return;const{code:s}=t,[i]=[...this.nodeMap.values()],n=i.isEditingState();"Space"!==s||n?"Escape"===s&&this.config.emit(x.NODE.EDITING,{editing:!1,nodeUI:i}):(t.stopPropagation(),e.hideSelection(),this.config.emit(x.NODE.EDITING,{editing:!0,nodeUI:i}))})),f.event.keydown(e.$viewport,(t=>{const e=this.getNodes();lt(e)||(t.stopPropagation(),t.stopImmediatePropagation(),gt(this,e[0].parent,e[0]))}),"enter"),f.event.keydown(e.$viewport,(t=>{const e=this.getNodes();lt(e)||(t.stopPropagation(),t.stopImmediatePropagation(),gt(this,e[0],e[0].lastChild()))}),"shift@enter"),f.event.keydown(e.$viewport,(t=>{const e=this.getNodes();var s;(t=>0===t.length||!!t.find((t=>t.root)))(e)||(t.stopPropagation(),t.stopImmediatePropagation(),s=e,this.config.mindWired().deleteNodes(s),ht(this.nodeMap),ut(this))}),"delete")}isEmpty(){return 0===this.nodeMap.size}getNodes(){return[...this.nodeMap.values()]}}(e);class pt{constructor(t){this.config=t,this.node=null,this.config.listen(x.VIEWPORT.CLICKED,(()=>{this.close()})),this.config.listen(x.NODE.SELECTED,(({node:t})=>{this.node!==t&&this.close(this.node)}))}isEditing(){return!!this.node}edit(t){this.node&&(this.close(),this.node=null),this.config.getNodeRenderer().getRenderer(t.model.type).editor(t),this.node=t,this.node.setEditingState(!0)}close(){this.node&&(this.node.setEditingState(!1),this.config.getCanvas().hideNodeEditor(this.node)),this.node=null}}const mt='<span class="mwd-node-text"></span>',yt='<div class="mwd-node-editor plain-text-editbox">\n    <textarea value=""></textarea>\n    <button data-cmd="save">SAVE</button>\n  </div>',vt='<div class="icon-badge-node">\n    <img>\n    <span class="mwd-node-text"></span>\n  </div>',Et='<div class="mwd-thumbnail-node"><img draggable="false"></div>',xt='\n  <div class="mwd-node-editor thumnail-editor">\n    <div class="inline-mwd-form">\n      <input type="text" data-form-size>\n    </div>\n    <div class="preview">\n      <img class="img"></img>\n    </div>\n    <div class="path-form">\n        <textarea></textarea>\n      </div>\n  </div>',wt=new Map,bt='<a href="#" target="_"></a>';class Dt{constructor(t){this.ctx=t}get name(){return"link"}install(t,e){const s=this.ctx.parse(bt),{model:i}=t,{body:n}=i.link;this.ctx.getRenderer(n.type||"text").install(t,s),e.append(s)}render(t,e){const{url:s,body:i}=t.link,n=this.ctx.query(e,"a");n.href=s,this.ctx.getRenderer(i.type||"text").render(i,n)}}const Nt=t=>{const e=(t=>new class{constructor(t){this.canvas=t,this.uid=`node-rctx-${(t=>{t=t||16;let e="";for(;e.length<t;)e+=Math.random().toString(36).substring(2);return e.substring(0,t)})()}`,wt.set(this.uid,new Map),this.editingNode=null}get event(){return f.event}get valid(){return f.valid}parse(t,e){const s=f.parseTemplate(t);return e&&f.css(s,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}),s}register(t){wt.get(this.uid).set(t.name,t)}getNodeBody(t){return this.canvas.getNodeBody(t)}getRenderer(t){const e=wt.get(this.uid).get(t||"text");if(!e)throw new Error(`[No Renderer] no such renderer, (type:${t})`);return e}select(t,e){return t.$bodyEl.querySelector(e)}installEditor(t,e){return this.editingNode=t,this.canvas.showNodeEditor(t,e)}css(t,e){f.css(t,e)}query(t,e){return f.findOne(t,e)}endEditing(){this.canvas.hideNodeEditor(this.editingNode),this.canvas.config.emit(x.NODE.EDITING,{editing:!1,nodeUI:this.editingNode}),this.editingNode=null}}(t))(t),s=new class{constructor(t){this.ctx=t}install(t,e){const s=this.ctx.parse(mt);e.append(s)}render(t,e){const s=this.ctx.query(e,".mwd-node-text"),i=t.text.split("\n").map((t=>`<p>${t}</p>`)).join("");s.innerHTML=i}editor(t){const e=this.ctx.parse(yt,!0),s=this.ctx.query(e,"textarea"),{model:i}=t;return s.value=i.text,this.ctx.css(s,{width:120,height:40}),this.ctx.event.click(e,(e=>{"save"===e.target.dataset.cmd&&(t.updateModel((t=>(t.text=s.value.trim(),!0))),this.ctx.endEditing())})),this.ctx.installEditor(t,e).then((()=>{s.focus()})),e}get name(){return"text"}}(e);e.register(s);const i=new class{constructor(t){this.ctx=t}get name(){return"icon-badge"}install(t,e){const s=this.ctx.parse(vt);e.append(s)}render(t,e){const{icon:s,text:i}=t["icon-badge"];this.ctx.query(e,"img").src=s,this.ctx.query(e,".mwd-node-text").innerText=i}startEditing(t){console.log(t)}}(e);e.register(i);const n=new class{constructor(t){this.ctx=t}get name(){return"thumbnail"}install(t,e){const s=this.ctx.parse(Et);e.append(s)}render(t,e){const s=this.ctx.query(e,".mwd-thumbnail-node img");this.ctx.css(s,{width:t.thumbnail.size,height:"auto"}),s.src=t.thumbnail.path}editor(t){const{model:e}=t;if("thumbnail"!==e.type)throw new Error("EDITOR_ERROR:not a thumbnail node");const{path:s,size:i}=e.thumbnail,n=this.ctx.parse(xt,!0),o=this.ctx.query(n,"input");o.value=i,this.ctx.event.keyup(o,(e=>{const s=e.target.value.trim();this.ctx.valid.number(s).then((e=>{t.updateModel((t=>(t.thumbnail.size=e,this.ctx.css(d,{width:e}),!0)))}))}),"enter");const r=this.ctx.query(n,"textarea");this.ctx.event.keydown(r,(e=>{const s=e.target.value.trim();this.ctx.valid.path(s).then((e=>{t.updateModel((t=>(t.thumbnail.path=e,d.src=e,!0)))}))}),"enter");const d=this.ctx.query(n,".preview .img");this.ctx.css(d,{width:i,height:"auto"}),d.src=s;let a=!1;this.ctx.event.click(d,(t=>{a=!a;const s=a?"flex":"none",i=this.ctx.query(n,".path-form");this.ctx.css(i,{display:s}),a&&(r.value=e.thumbnail.path)})),this.ctx.installEditor(t,n).then((()=>{console.log("done")}))}}(e);e.register(n);const o=new Dt(e);return e.register(o),e},Ct=(t,e,s,i)=>{if(t.includes(e))return;const n=e.dimension();s.add(n.y),s.add(n.cy),s.add(n.b),i.add(n.x),i.add(n.cx),i.add(n.r),e.isFolded()||e.subs.forEach((e=>{Ct(t,e,s,i)}))},Ot=t=>Math.abs(t),It=(t,e,s)=>t.reduce(((t,i)=>{const n=e[s]-t,o=e[s]-i;return Ot(n)<=Ot(o)?t:i}),t[0]),Tt=t=>t.reduce(((e,s,i)=>Ot(s)<Ot(t[e])?i:e),0),$t=(t,e,s)=>{t.strokeStyle=e.snap.color[s],t.lineWidth=e.snap.width||.4,e.snap.dash&&t.setLineDash(e.snap.dash)};class St{constructor(t){this.config=t}turnOn(t,e){if(!e||0===e.length||!this.config.snapEnabled)return;const s=new Set,i=new Set;this.activeNodes=[...e],Ct(e,t,i,s,this.config.scale),this.snaps={hLines:i,vLines:s}}turnOff(){this.callback=null,this.snaps=null,this.node=null}doAlign(){if(!this.snaps||0===this.snaps.length)return;const{ui:t}=this.config,e=this.activeNodes[0],s=t.snap.limit,i=t.snap.limit,n=this.config.getCanvas();n.clear();const o=e.dimension(),r=[...this.snaps.vLines.values()].filter((t=>Math.abs(o.x-t)<=s||Math.abs(o.r-t)<=s||Ot(o.cx-t)<=s)),d=[...this.snaps.hLines.values()].filter((t=>Math.abs(o.y-t)<=s||Math.abs(o.b-t)<=s||Math.abs(o.cy-t)<=s)),a={x:0,y:0};if(r.length>0){const e=It(r,o,"x"),s=It(r,o,"cx"),d=It(r,o,"r"),c=[s-o.cx,e-o.x,d-o.r],h=Tt(c);Ot(c[h])<=i&&(a.x=c[h]),this.config.snapEnabled&&n.drawVLines([e,s,d],(e=>$t(e,t,"vertical")))}if(d.length>0){const e=It(d,o,"y"),s=It(d,o,"cy"),r=It(d,o,"b"),c=[s-o.cy,e-o.y,r-o.b],h=Tt(c);Ot(c[h])<=i&&(a.y=c[h]),this.config.snapEnabled&&n.drawHLines([e,s,r],(e=>$t(e,t,"horizontal")))}this.activeNodes.forEach((t=>{const e=t.offset();e.x+=a.x,e.y+=a.y,t.setOffset(e)}))}}const Rt=t=>t,Lt=(t,e,s)=>{const i=e.toNodeConfigs(s,t);return t.childSetOf(e.name).forEach((s=>{Lt(t,s,e)})),i};class Mt{constructor(t,e,s,i){this.name=t,this.userDataList=e,this.parentType=s,this.callbacks=i}toNodeConfigs(t,e){let s=t?this.callbacks.relation:null;return this.userDataList.map(((i,n)=>{const o={userData:i,subs:[]},{model:r}=this.callbacks;if(o.model="function"==typeof r?r(i):E.deepCopy(r),s){const n=s(i,t.userDataList),r=e.$ref.get(n);o.idx=r.subs.length,r.subs.push(o)}const{view:d}=this.callbacks;return o.view="function"==typeof d?d(i,o.idx):"object"==typeof d?E.deepCopy(d):{x:0,y:0},e.$ref.set(i,o),o}))}}class Pt{constructor(){this.dataSets=new Map,this.rootType=null,this.$ref=new Map}root(t,e,s){const i=[];return s?i.push(e):(s=e,i.push({})),s.virtual,this.rootType=t,s.relation=Rt,this.dataSet(t,i,s)}childSetOf(t){return[...this.dataSets.values()].filter((e=>e.parentType===t))}dataSet(t,e,s){const i={};i.relation=s.relation||Rt,i.model=s.model||Rt,i.view=s.view;const n=t.trim();if(this.dataSets.has(n))throw new Error(`[MIND WIRED] existing data type: [${t}]`);const o=new Mt(n,e,s.parent,i);return this.dataSets.set(n,o),this}build(){const t=this.dataSets.get(this.rootType);return Lt(this,t)[0]}}const At=(t,e)=>{t.set(e,e.getPos()),e.subs.forEach((e=>At(t,e)))};class Ut{constructor(t,e){this.node=t,this.pos=t.getPos(),this.dir=new class{constructor(t){this.node=t,this.prev=null,this.capture()}get horizontal(){const{x:t}=this.node;return t<=0?-1:1}get vertical(){const{y:t}=this.node;return t<=0?-1:1}updated(t){const{dir:e,pos:s}=(t=>"LR"===t?{dir:"horizontal",pos:[-1,1]}:"RL"===t?{dir:"horizontal",pos:[1,-1]}:"TB"===t?{dir:"vertical",pos:[-1,1]}:"BT"===t?{dir:"vertical",pos:[1,-1]}:void 0)(t),i=this[e];return this.prev[e]===s[0]&&i===s[1]}capture(){const{x:t,y:e}=this.node;this.prev={horizontal:t<=0?-1:1,vertical:e<=0?-1:1}}}(t),At(e,t)}}class kt{constructor(){this.capture=new Map,this.posMap=new Map}prepareDnd(t){this.clear(),t.filter((t=>!t.isRoot())).forEach((t=>{this.capture.set(t,new Ut(t,this.posMap))}))}eachCapture(t){for(let e of this.capture.values())t(e)}getUpdatedNodes(){let t=[];return this.posMap.forEach(((e,s)=>{e.x===s.x&&e.y===s.y||t.push(s)})),t}clear(){this.capture.clear(),this.posMap.clear()}}const zt=(t,e)=>{const s=e.config.view,i={x:s.x,y:s.y};e.isRoot()&&(i.x=t.ui.offset.x,i.y=t.ui.offset.y),s.layout&&(i.layout=s.layout),s.edge&&(i.edge=s.edge);const n=[];return e.subs.forEach((e=>{n.push(zt(t,e))})),{model:e.model,view:i,subs:n}},Wt=(t,e,s=!0)=>{e.repaint(),s&&e.subs.forEach((e=>{Wt(t,e)}))},Ht=(t,e,s)=>{const i=s.nodeLevelClassName(t);f.clazz[e](t.$bodyEl,i),t.subs.forEach((t=>Ht(t,e,s)))};class qt{constructor(t){this.config=t,t.mindWired=()=>this,this.canvas=new class{constructor(t){var e;this.config=t,this.$viewport=(t=>{const{el:e,ui:s}=t.config,i=s.width||600,n=s.height||600;let o=f.findOne(e,"[data-mind-wired-viewport]");return o||(o=f.parseTemplate(U.viewport,{}),e.append(o)),f.attr(o,"tabIndex","0"),f.css(o,{width:i,height:n}),o})(this),z(this),this.dndContext=(e=this,new R({accept:t=>{const s=e.config.mindWired();if(f.closest(t,"[data-editor-element]"))return!1;if(f.is(t,'[data-cmd="set-para"]'))return e.dndContext.capture("handler",(t=>({beforeDrag:e=>{const{target:s}=e.originalEvent,i=s,{scale:n}=(t.config.mindWired(),t.config);t.dndContext.capture("iconEl",i)},dragging:e=>{const{dx:s,dy:i}=e,n=t.dndContext.getData("iconEl");f.css(n,{transform:`translate(calc(-50% + ${s}px), ${i}px)`})},afterDrag:()=>{const e=t.dndContext.getData("iconEl"),s=f.domRect(e),i=s.x+s.width/2,n=s.y+s.height/2;f.css(e,{transform:"translate(-50%, 0)"});const o=t.findNodeAt(i,n);if(o){const e=t.config.mindWired().getSelectedNodes();e.filter((t=>o.isDescendantOf(t))).length>0||t.config.mindWired().moveNodes(o,e,!0)}}}))(e)),!0;if(f.closest(t,"[data-cmd]"))return!1;if(f.is(t,"canvas"))return e.dndContext.capture("handler",(t=>({beforeDrag:e=>{t.dndContext.capture("offset",t.config.getOffset())},dragging:e=>{const{dx:s,dy:i}=e;t.dndContext.capture("dragged",!0);const n=t.dndContext.getData("offset");t.config.emit(x.DRAG.VIEWPORT,{state:"DRAG",offset:{x:n.x+s,y:n.y+i}})},afterDrag:e=>{const{dx:s,dy:i}=e,n=t.dndContext.getData("offset");t.config.emit(x.DRAG.VIEWPORT,{state:"DONE",offset:{x:n.x+s,y:n.y+i}}),t.dndContext.getData("dragged")||t.config.emit(x.VIEWPORT.CLICKED)}}))(e)),!0;if(f.is(t,".mwd-node")){const i=t.dataset.uid;return e.dndContext.capture("handler",(t=>({beforeDrag:e=>{const{target:s}=e.originalEvent,i=f.closest(s,".mwd-node").dataset.uid;t.dndContext.capture("nodeId",i);const n=t.config.mindWired().findNode((t=>t.uid===i));t.config.emit(x.NODE.SELECTED,{node:n,append:e.originalEvent.shiftKey}),t.config.emit(x.DRAG.NODE,{nodeId:i,state:"READY",target:e.originalEvent.shiftKey?"children":"all",x:0,y:0})},dragging:e=>{const{dx:s,dy:i}=e,n=t.dndContext.getData("nodeId"),{scale:o}=t.config;t.config.emit(x.DRAG.NODE,{nodeId:n,state:"DRAG",target:e.originalEvent.shiftKey?"children":"all",x:s/o,y:i/o})},afterDrag:e=>{const{dx:s,dy:i}=e,n=t.dndContext.getData("nodeId"),{scale:o}=t.config;t.config.emit(x.DRAG.NODE,{nodeId:n,state:"DONE",target:e.originalEvent.shiftKey?"children":"all",x:s/o,y:i/o})}}))(e)),e.dndContext.capture("nodeId",i),e.dndContext.capture("editing",s.isEditing()),!0}return!1},beforeDrag:t=>{e.dndContext.getData("handler").beforeDrag(t)},dragging:t=>{e.dndContext.getData("editing")||e.dndContext.getData("handler").dragging(t)},afterDrag:t=>{e.dndContext.getData("editing")||e.dndContext.getData("handler").afterDrag(t)}}));let s=null;this.resizeObserver=new ResizeObserver((()=>{clearTimeout(s),s=setTimeout(z,150,this)})),this.resizeObserver.observe(this.$viewport),this.selectionArea=null}get $canvas(){return this.$viewport.querySelector("canvas")}get $holder(){return this.$viewport.querySelector(".mwd-nodes")}get scale(){return this.config.scale}getContext(){return this.$ctx}getHolderOffset(){const t=this.$holder;return{x:t.offsetLeft,y:t.offsetTop}}getDimension(){const t=this.$canvas;return{width:t.offsetWidth,height:t.offsetHeight}}elemOf(t){return this.$viewport.querySelector(t)}shiftBy(t,e){const s=this.config.getOffset();s.x+=t,s.y+=e,this.config.setOffset(s),this.repaintNodeHolder()}findNodeAt(t,e){const s=this.$holder.querySelectorAll(".mwd-body");let i=null;for(let n=0;n<s.length;n++){const o=f.domRect(s[n]);if(o.left<=t&&o.right>=t&&o.top<=e&&o.bottom>=e){i=s[n];break}}if(!i)return null;const n=this.config.mindWired(),o=f.closest(i,".mwd-node");return n.findNode((t=>t.uid===o.dataset.uid))}drawPath(t,e,s){const i=this.getContext();i.save(),q(i,e,s);let n=t[0];t=t.slice(1);const o=this.getHolderOffset();i.beginPath(),i.moveTo(o.x+n.x,o.y+n.y),t.forEach((t=>{i.lineTo(o.x+t.x,o.y+t.y)})),i.stroke(),i.restore()}drawCurve(t,e,s,i){const n=this.getContext();n.save(),q(n,s.props,i);const o=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)),r=s.degree,d=o*s.ratio/o,a=P(t,e,r,{scale:d}),c=P(e,t,r,{scale:d}),h=this.getHolderOffset();n.beginPath(),n.moveTo(h.x+t.x,h.y+t.y),n.bezierCurveTo(h.x+a.x,h.y+a.y,h.x+c.x,h.y+c.y,h.x+e.x,h.y+e.y),n.stroke(),n.restore()}drawBeizeCurve(t,e,s,i){const n=this.getContext();n.save(),q(n,s.props,i);const[o,r]=s.cpoints,d=this.getHolderOffset();n.beginPath(),n.moveTo(d.x+t.x,d.y+t.y),n.bezierCurveTo(d.x+o.x,d.y+o.y,d.x+r.x,d.y+r.y,d.x+e.x,d.y+e.y),n.stroke(),n.restore()}drawVLines(t,e){const s=this.$viewport.offsetHeight,i=this.getContext();i.save(),"function"==typeof e&&e(i),i.beginPath();const n=this.getHolderOffset();t.forEach((t=>{i.moveTo(n.x+t,0),i.lineTo(n.x+t,s)})),i.stroke(),i.closePath(),i.restore()}drawHLines(t,e){const s=this.$viewport.offsetWidth,i=this.getContext();i.save(),"function"==typeof e&&e(i),i.beginPath();const n=this.getHolderOffset();t.forEach((t=>{i.moveTo(0,n.y+t),i.lineTo(s,n.y+t)})),i.stroke(),i.closePath(),i.restore()}clear(){const t=this.getDimension(),e=this.getContext();e.fillStyle="white",e.fillRect(0,0,t.width,t.height)}repaintNodeHolder(){const t=this.config.getOffset(),{scale:e}=this.config;f.css(this.$holder,{top:`calc(50% + ${t.y}px)`,left:`calc(50% + ${t.x}px)`,transform:`scale(${e})`}),this.selectionArea&&this.selectionArea.draw(this)}moveNode(t){const{parent:e}=t;f.findOne(e.$el,".mwd-subs").append(t.$el)}drawSelection(t){if(!t||0===t.length)return;this.hideSelection();const e=t.map((t=>new k(t,this.scale)));this.selectionArea=e.reduce(((t,e)=>t.merge(e)),e[0]),this.selectionArea.draw(this)}hideSelection(){this.selectionArea&&(this.selectionArea.clear(this),this.selectionArea=null)}drawNode(t){t.$el||W(this,t);const{uid:e}=t,s=(f.findOne(this.$holder,`[data-uid="${e}"]`),this.config.getNodeRenderer()),{model:i}=t,n=i.type||"text";s.getRenderer(n).render(t.model,this.getNodeBody(t),t)}showNodeEditor(t,e){const{uid:s}=t;return this.$holder.querySelector(`[data-uid=${s}]`).append(e),e.dataset.editorElement="",new Promise((t=>{setTimeout(t)}))}hideNodeEditor(t){const{uid:e}=t,s=this.$holder.querySelector(`[data-uid=${e}]`),i=f.findOne(s,"[data-editor-element]");i&&i.remove(),f.findOne(s,".mwd-body").focus()}regsiterNode(t){W(this,t)}unregisterNode(t){((t,e)=>{if(!e.$el)throw new Error(`[MINDWIRED][ERROR] not registered node. (${e.uid})`);e.$el.remove(),delete e.$el})(0,t),this.hideSelection()}updateFoldingNodes(t){const e=t.isFolded()?"none":"";t.subs.forEach((t=>{H(t,e)}));const s=f.findOne(this.$holder,`[data-uid="${t.uid}"]`);if(t.isFolded()){const e=f.domRect(t.$bodyEl),i=f.parseTemplate(U.foldingControl,{});f.css(i,{width:20,height:20,transform:`translate(${e.width/2}px, -50%)`,zIndex:0}),s.append(i),f.event.click(i,(e=>{e.stopPropagation(),t.setFolding(!1)}))}else f.findOne(s,':scope > [data-cmd="unfolding"]').remove()}getNodeBody(t){let e=t.$el;return e||(e=W(this,t)),e.querySelector(".mwd-body")}}(t),t.getCanvas=()=>this.canvas,this.nodeRenderingContext=Nt(this.canvas),t.getNodeRenderer=()=>this.nodeRenderingContext,this.nodeSelectionModel=ft(0,t),this.nodeEditor=new pt(t),this.alignmentUI=new St(t),this.dragContext=new kt,this.config.listen(x.DRAG.VIEWPORT,(t=>{if(this.config.setOffset(t.offset),this.canvas.repaintNodeHolder(),this.edgeUI.repaint(),"DONE"===t.state){this.rootUI.setPos(t.offset.x,t.offset.y);try{this.config.emit(x.NODE.UPDATED.CLIENT,{nodes:[this.rootUI],type:"pos"})}finally{this.rootUI.setPos(0,0)}}})),this.config.listen(x.DRAG.NODE,(t=>{if("READY"===t.state){const e=this.nodeSelectionModel.getNodes(),s="all"===t.target?e:e.flatMap((t=>t.subs));this.dragContext.prepareDnd(s),this.alignmentUI.turnOn(this.rootUI,s),this.canvas.drawSelection(e)}else if("DRAG"===t.state){const e="all"===t.target?1:2.5;this.dragContext.eachCapture((s=>{const{node:i,dir:n,pos:o}=s;n.capture(),i.setPos(e*t.x+o.x,e*t.y+o.y,!this.config.snapEnabled)})),this.alignmentUI.doAlign(),this.dragContext.eachCapture((t=>{const{node:e,dir:s}=t;ct.layout(e,{dir:s,layoutManager:ct})})),this.canvas.drawSelection(this.nodeSelectionModel.getNodes()),this.edgeUI.repaint(!this.config.snapEnabled,!1)}else if("DONE"===t.state){this.alignmentUI.turnOff(),this.edgeUI.repaint(!0);const t=this.dragContext.getUpdatedNodes();t.length>0&&this.config.emit(x.NODE.UPDATED.CLIENT,{nodes:t,type:"pos"}),this.dragContext.clear()}})).listen(x.NODE.EDITING,(({editing:t,nodeUI:e})=>{t?this.nodeEditor.edit(e):this.nodeEditor.close()})).listen(x.NODE.FOLDED,(({node:t})=>{this.canvas.updateFoldingNodes(t)})).listen(x.NODE.UPDATED,(t=>{t.forEach((t=>t.repaint())),this.edgeUI.repaint(),this.config.emit(x.NODE.UPDATED.CLIENT,{nodes:t,type:"model"})}))}isEditing(){return this.nodeEditor.isEditing()}nodes(t){if(t instanceof Pt){const e=t.build();this.rootUI=st.build(e,this.config)}else this.rootUI=st.build(t,this.config);return this.edgeUI=new class{constructor(t,e,s){this.config=t,this.canvas=s,this.edges=[],K(e,this.edges),this.config.listen(x.NODE.CREATED,(({nodes:t})=>{t.forEach((t=>{const e=new J(t.parent,t);this.edges.push(e)})),this.repaint()})).listen(x.VIEWPORT.RESIZED,(()=>{this.repaint()})).listen(x.NODE.DELETED,(t=>{const e=_(this.edges,(e=>e.matched(t)));0===e.length||(e.reverse().forEach((t=>this.edges.splice(t,1))),this.repaint())})).listen(x.NODE.MOVED,(({node:t,prevParent:e})=>{const s=_(this.edges,(s=>s.src===e&&s.dst===t));s.length>0&&s.reverse().forEach((t=>this.edges.splice(t,1)));const i=new J(t.parent,t);this.edges.push(i),this.repaint()})).listen(x.NODE.FOLDED,(({node:t})=>{const e=this.edges.filter((e=>e.src===t)),s=t.isFolded();e.forEach((t=>{t.hidden=s,Z(this,t,s)})),this.repaint()}))}filterEdges(t){return this.edges.filter(t)}repaint(t=!0){t&&this.canvas.clear(),this.edges.forEach((t=>{const{src:e,dst:s}=t,i=s.$cachedStyle||new V(s);s.$cachedStyle=i,t.hidden||Y[i.name.toUpperCase()](this.canvas,e,s)}))}}(this.config,this.rootUI,this.canvas),this.config.ui.offset.x=this.rootUI.config.view.x,this.config.ui.offset.y=this.rootUI.config.view.y,this.rootUI.config.view.x=0,this.rootUI.config.view.y=0,this.repaint(),this}findNode(t){return this.rootUI.find(t)}addNode(t,e,s){const i={model:e.model,view:e.view};i.view||(i.view={x:100,y:0});const n=new st(i,this.config,t);if(this.canvas.regsiterNode(n),t.addChild(n),e.siblingNode){const t=f.domRect(e.siblingNode.$bodyEl);ct.setPosition(n,{baseNode:e.siblingNode,rect:t})}n.repaint(),this.config.emit(x.NODE.CREATED,{nodes:[n]},!0),s&&(s.editing||s.select)&&this.config.emit(x.NODE.SELECTED,{node:n}),s&&s.editing&&this.nodeEditor.edit(n)}moveNodes(t,e,s){const i=e.filter((e=>e.parent!==t));i.forEach((e=>{Ht(e,"remove",this.config);const s=t.addChild(e);Ht(e,"add",this.config),this.config.emit(x.NODE.MOVED,{node:e,prevParent:s})})),t.setFolding(!1),Wt(this,t),this.canvas.drawSelection(e),s&&this.config.emit(x.NODE.UPDATED.CLIENT,{nodes:i,type:"path"})}deleteNodes(t){const e=[],s=[];t.forEach((i=>{const{parent:n,childNodes:o}=i;o.length>0&&(o.forEach((t=>{t.setPos(t.x+i.x,t.y+i.y)})),this.moveNodes(n,o),e.push(...o.filter((e=>!t.includes(e)))));const r=i.parent.removeChild(i);r&&(this.canvas.unregisterNode(r),this.config.emit(x.NODE.DELETED,r),s.push(i))})),e.length>0&&this.config.emit(x.NODE.UPDATED.CLIENT,{nodes:e,type:"path"}),s.length>0&&this.config.emit(x.NODE.DELETED.CLIENT,{nodes:s})}getSelectedNodes(){return this.nodeSelectionModel.getNodes()}setLayout(t,e){(e||this.rootUI).config.view.layout=t,this.repaint()}setEdge(t,e){(e||this.rootUI).config.view.edge=t,this.repaint(e)}setScale(t){this.config.ui.scale=t,console.log(this.config.ui.scale),this.repaint()}repaint(t){t=t||this.rootUI,Wt(this,t),this.canvas.repaintNodeHolder(),ct.layout(t,{dir:null}),this.edgeUI.repaint(),this.canvas.hideSelection(),this.canvas.drawSelection(this.getSelectedNodes())}listen(t,e){return this.config.ebus.listen(`${t}.client`,e),this}export(){const t=zt(this.config,this.rootUI);return Promise.resolve(JSON.stringify(t))}}const Bt={width:600,height:600,scale:1,clazz:{node:"active-node",edge:"active-edge",schema:t=>t,level:t=>`level-${t}`},offset:{x:0,y:0},snap:{limit:4,width:.4,dash:[6,2],color:{horizontal:"orange",vertical:"#2bc490"}},selection:{padding:5,"background-color":"#b3ddff6b","border-radius":"4px"}};class Ft{constructor({el:t,ui:e}){this.el=t,this.ui=e,this.ebus=new b}get width(){return this.ui.width}get height(){return this.ui.height}get scale(){return this.ui.scale}get snapEnabled(){return this.ui.snap.enabled}getOffset(){return{...this.ui.offset}}setOffset(t){this.ui.offset={...t}}relativeOffset(t){const e=this.ui.offset;return{x:e.x+t.x,y:e.y+t.y}}activeClassName(t){const e=this.ui.clazz[t];if(!e)throw new Error(`[MINDWIRED][ERROR] no classname of type : "${t}"`);return e}nodeLevelClassName(t){const e=this.ui.clazz.level;if(!f.types.method(e))throw new Error(`clazz.level should be function, but ${typeof e}. (level, node) => {} `);return e?e(t.level(),t):`level-${t.level()}`}listen(t,e){return this.ebus.on(t,e),this}off(t,e){this.ebus.off(t,e)}emit(t,e,s){return this.ebus.emit(t,e,!!s),this}}Ft.parse=t=>{t.el;const e=E.mergeLeaf(t.ui||{},E.deepCopy(Bt));(t=>{const{snap:e}=t;!1===e?(t.snap=E.deepCopy(Bt.snap),t.snap.enabled=!1):(f.valid.string(e.color)&&(e.color={horizontal:e.color.trim(),vertical:e.color.trim()}),e.limit=e.limit||Bt.snap.limit,e.width=e.width||Bt.snap.width,!1!==e.dash&&(e.dash=e.dash||Bt.snap.dash),e.enabled=!0)})(e);const s="string"==typeof t.el?document.querySelector(t.el):t.el;return new Ft({el:s,ui:e})};const Vt=Ft;window.addEventListener("DOMContentLoaded",(t=>{(()=>{const t=document.querySelector("[mind-wired-holder]");if(t){let e=f.findOne(t,"canvas");e||(e=(t=>{const e=f.tag.canvas();t.append(e)})(t))}})()}));const jt=t=>{const{el:e}=t;return new Promise(((s,i)=>{if(e){const e=Vt.parse(t);s(new qt(e))}else i({cause:"no_css_selector"})}))},Gt=()=>new Pt,Xt={init:jt,createDataSource:Gt};return e})()));
//# sourceMappingURL=mind-wired.js.map